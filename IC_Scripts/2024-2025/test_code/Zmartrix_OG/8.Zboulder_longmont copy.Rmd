---
title: "boulder_longmont"
output: pdf_document
date: "2025-06-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(sf)
library(dplyr)
library(ggplot2)
library(spam)
library(fields)

setwd("~/Desktop/MINES/COGCC-Risk-Analysis/IC_Scripts/2024-2025/sp_point_data")
source("ZlogisticSmoother.R")       
source("ZLambdaGridSearch.R")
```

```{r}
usable_sf <- st_read("usable_point_data.geojson")

df <- usable_sf %>%
  st_drop_geometry() %>%
  select(-unique_id) %>%
  mutate(
    lon = as.numeric(sub("^\\((.*),.*$", "\\1", coords)),
    lat = as.numeric(sub("^.*,\\s*(.*)\\)$",  "\\1", coords))
  ) %>%
  filter(
    lon >= -105.85,
    lon <=  -104.79 + 0.2,  
    lat >=  39.42,
    lat <=  40.68
  )

model_data <- df %>%
  select(lon, lat, risk)

model_data %>% count(risk) %>% mutate(prop = n/sum(n))

ggplot(model_data, aes(x = lon, y = lat, color = factor(risk))) +
  geom_point(size = 1.7, alpha = 0.8) +
  scale_color_manual(
    name   = "Risk (0/1)",
    values = c("0" = "skyblue", "1" = "firebrick")
  ) +
  coord_fixed() +
  theme_minimal() +
  labs(
    title = "Zoomed to Boulder–Greeley",
    x     = "Longitude",
    y     = "Latitude"
  )
```

```{r}
coord_model <- as.matrix(model_data[, c("lon","lat")])
risk_model  <- model_data$risk

model_df <- data.frame(
  lon  = coord_model[, 1],
  lat  = coord_model[, 2],
  risk = risk_model
)

profile <- LambdaGridSearch(
  as.matrix(model_df[, c("lon", "lat")]),   
  model_df$risk,                            
  init_nuOld   = NULL,
  warm_start   = FALSE,
  Z            = NULL
)

PlotLambdaProfile(profile)

bestLambda <- profile$bestLambda
MLEFit     <- logisticSmoother(
  as.matrix(model_df[, c("lon", "lat")]),
  model_df$risk,
  lambda = bestLambda
)
```

```{r}
to.factor <- c("status","flowline_action","location_type","fluid","material")
df_mutated <- df %>%
  mutate(across(all_of(to.factor), as.factor))
df_mutated <- as.data.frame(df_mutated)

X <- model.matrix(~ status + flowline_action + location_type + fluid + material +
                    diameter_in + length_ft + line_age_yr, data = df_mutated)[, -1]

Z <- X[, c("statusNew_Construction",
           "flowline_actionRealignment",
           "flowline_actionRegistration",
           "location_typeWell_Site",
           "fluidMultiphase",
           "fluidOther",
           "materialSteel",
           "diameter_in",
           "length_ft",
           "line_age_yr")]

Z_df <- as.data.frame(Z)
Z_df$risk <- df$risk                       

glm_sel <- glm(risk ~ ., data = Z_df, family = binomial(link = "logit"))
nu_cov  <- predict(glm_sel, type = "link")
```

```{r}
glm_profile <- LambdaGridSearch(coord_model, 
                            risk_model, 
                            init_nuOld = nu_cov, 
                            warm_start = TRUE,
                            Z=Z)

PlotLambdaProfile(glm_profile)

glm_bestLambda <- glm_profile$bestLambda
glm_MLEFit     <- logisticSmoother(
  coord_model,
  risk_model,
  lambda = glm_bestLambda
)
```

```{r}
nu_all_mle <- predict(MLEFit, coord_model)
prob_all_mle <- exp(nu_all_mle) / (1 + exp(nu_all_mle))
model_data_mle <- model_data %>%
  mutate(predicted_prob = prob_all_mle)

ggplot(model_data, aes(x = lon, y = lat)) +
  geom_point(aes(color = factor(risk)), size = 2, alpha = 0.8) +
  scale_color_manual(
    values = c("0" = "skyblue", "1" = "firebrick"),
    name   = "Observed Risk",
    labels = c("0" = "No Spill", "1" = "Spill")
  ) +
  coord_fixed() +
  theme_minimal() +
  labs(
    title = "Observed Spill Risk",
    x     = "Longitude",
    y     = "Latitude"
  )

ggplot(model_data_mle, aes(x = lon, y = lat)) +
  geom_point(aes(color = predicted_prob), size = 2) +
  scale_color_viridis_c(option = "D", name = "Predicted Risk") +
  coord_fixed() +
  theme_minimal() +
  labs(
    title = "Predicted Risk",
    x     = "Longitude",
    y     = "Latitude"
  )
```
 
```{r}
pearson_resid <- (risk_model - prob_all_mle) / sqrt(prob_all_mle * (1 - prob_all_mle))

qqnorm(pearson_resid,
       main = "QQ plot of Pearson Residuals",
       xlab = "Theoretical Quantiles",
       ylab = "Observed Residuals")
qqline(pearson_resid, lty = 2)
```
 
```{r}
set.seed(222)
n <- length(risk_model)
qresid <- numeric(n)
for(i in seq_len(n)){
  p <- prob_all_mle[i]
  if(risk_model[i]==1){
    lo <- p; hi <- 1
  } else {
    lo <- 0; hi <- 1 - p
  }
  u      <- runif(1, lo, hi)
  qresid[i] <- qnorm(u)
}

ggplot(data.frame(resid=qresid), aes(sample=resid)) +
  stat_qq() + stat_qq_line() +
  labs(title="QQ plot of Dunn–Smyth Residuals",
       x="Theoretical Normal", y="Sample Residuals")
```
 
```{r}
nu_hat     <- predict(MLEFit, coord_model)
p_hat   <- exp(nu_hat) / (1 + exp(nu_hat))
risk_model <- model_data$risk
loglik_i   <- risk_model * log(p_hat) + 
              (1 - risk_model) * log(1 - p_hat)
total_loglik <- sum(loglik_i)
print(paste("Total log-likelihood =", round(total_loglik, 2)))
```

```{r}
nu_se  <- predictSE(MLEFit, x = coord_model)
p_se <- nu_se * p_hat * (1 - p_hat) 

nu_lo <- nu_hat - 1.96 * p_se
nu_hi <- nu_hat + 1.96 * p_se

p_lo <- exp(nu_lo) / (1 + exp(nu_lo))
p_hi <- exp(nu_hi) / (1 + exp(nu_hi))

model_data_ci <- model_data %>%
  mutate(
    predicted_prob = p_hat,
    p_lo = p_lo,
    p_hi = p_hi
  ) %>%
  arrange(predicted_prob) %>%
  mutate(idx = row_number())  

ggplot(model_data_ci, aes(x = idx, y = predicted_prob)) +
  geom_ribbon(aes(ymin = p_lo, ymax = p_hi), fill = "lightblue", alpha = 0.3) +
  geom_line(color = "black", size = 1) +
  labs(
    x = "Observation (sorted by predicted risk)",
    y = "Predicted Spill Risk",
    title = "Predicted Spill Risk ± 95% CI"
  ) +
  theme_minimal()
```
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
```{r}
pred_obj <- predict(MLEFit, x = coord_model, se.fit = TRUE)
```
 
 
 
 
 
```{r}
nu_all_mle <- predict(MLEFit, coord_model)
prob_all_mle <- exp(nu_all_mle) / (1 + exp(nu_all_mle))
model_data_mle <- model_data %>%
  mutate(predicted_prob = prob_all_mle)

nu_glm_mle   <- predict(glm_MLEFit, coord_model)
prob_glm_mle <- exp(nu_glm_mle) / (1 + exp(nu_glm_mle))
model_data_glm_mle <- model_data %>%
  mutate(glm_predicted_prob = prob_glm_mle)

#Observed spill risk
ggplot(model_data, aes(x = lon, y = lat)) +
  geom_point(aes(color = factor(risk)), size = 2, alpha = 0.8) +
  scale_color_manual(
    values = c("0" = "skyblue", "1" = "firebrick"),
    name   = "Observed Risk",
    labels = c("0" = "No Spill", "1" = "Spill")
  ) +
  coord_fixed() +
  theme_minimal() +
  labs(
    title = "Observed Spill Risk",
    x     = "Longitude",
    y     = "Latitude"
  )

# Predicted risk on the full dataset (MLE λ)
ggplot(model_data_mle, aes(x = lon, y = lat)) +
  geom_point(aes(color = predicted_prob), size = 2) +
  scale_color_viridis_c(option = "D", name = "Predicted Risk") +
  coord_fixed() +
  theme_minimal() +
  labs(
    title = "Predicted Risk",
    x     = "Longitude",
    y     = "Latitude"
  )

ggplot(model_data_glm_mle, aes(x = lon, y = lat)) +
  geom_point(aes(color = glm_predicted_prob), size = 2, alpha = 0.8) +
  scale_color_viridis_c(option = "D", name = "Predicted Risk\n(GLM start)") +
  coord_fixed() +
  theme_minimal() +
  labs(
    title = "Predicted Spill Risk (Warm-started with GLM)",
    x     = "Longitude",
    y     = "Latitude"
  )
```
 
 