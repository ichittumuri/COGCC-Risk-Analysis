---
title: "fields_pt_data"
output: pdf_document
date: "2025-06-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)           
library(fields)          
library(pROC)           
library(dplyr)
library(LatticeKrig)
setwd("~/Desktop/MINES/COGCC-Risk-Analysis/IC_Scripts/2024-2025/sp_point_data")
```

```{r}
point_flowlines <- st_read("final_dataset.geojson")
drop.cols <- c("operator_number","flowline_id","location_id",
               "construct_date","spill_date","root_cause")
point_flowlines <- point_flowlines[, setdiff(names(point_flowlines), drop.cols)]
```

```{r}
df <- st_drop_geometry(point_flowlines)

na_rows <- df[!complete.cases(df), ]

risk_0 <- sum(na_rows$risk == 0, na.rm = TRUE)
risk_1 <- sum(na_rows$risk == 1, na.rm = TRUE)

cat("Rows with NAs and risk == 0:", risk_0, "\n")
cat("Rows with NAs and risk == 1:", risk_1, "\n")

df <- df[complete.cases(df), ]
```

```{r}
to.factor <- c("status","flowline_action","location_type","fluid","material")
df <- df %>% mutate(across(all_of(to.factor), as.factor))
```


```{r}
coord_mat <- do.call(rbind, strsplit(gsub("[()]", "", df$coords), ","))
coord_mat <- apply(coord_mat, 2, as.numeric)
colnames(coord_mat) <- c("lon", "lat")
```


```{r}
# Check for duplicates using R's default logic (based on numerical precision)
coord_rounded <- round(coord_mat, 6)

dupe_rows <- duplicated(as.data.frame(coord_rounded))
cat("R-level duplicates (rounded):", sum(dupe_rows), "\n")
```

```{r}
# mKrig checks for duplicate locations by converting each row into a string. Tiny differences vanish after string conversion, leading to dups. 

coord_strings <- cat.matrix(coord_mat)
dups_mkrig <- duplicated(coord_strings)
cat("mKrig-level duplicates:", sum(dups_mkrig), "\n")  # This shows duplicates, even if R's check didn't
```

```{r}
risk_dups <- df$risk[dups_mkrig]
table(risk_dups)
```

```{r}
# Drop mKrig-level duplicates and keep one copy per location, since only 2 duplicates are of risk = 1 
coord_clean <- coord_mat[!dups_mkrig, ]
y_clean <- df$risk[!dups_mkrig]
table(y_clean)
```


```{r}
nonzero_idx <- y_clean > 0
bubblePlot(coord_clean, y_clean,
           main = "Bubble Plot of Spill Risk",
           xlab = "Longitude", ylab = "Latitude")
```

```{r}
yTest <- ifelse(y_clean == 0, 0, 1)

# Get locations where a spill occurred
ind <- yTest == 1

plot(coord_clean[ind, ],
     main = "Spill Locations",
     xlab = "Longitude", ylab = "Latitude",
     pch = 16, col = "red", cex = 0.6)
```

```{r}
usable_point_data <- df[!dups_mkrig, ]

numeric_vars <- sapply(usable_point_data, is.numeric)
zero_counts <- sapply(usable_point_data[, numeric_vars], function(col) sum(col == 0, na.rm = TRUE))
cat("Number of zeros in each numeric variable:\n")
print(zero_counts[zero_counts > 0])
```

```{r}
numeric_cols <- names(numeric_vars)[numeric_vars]
numeric_cols_no_risk <- setdiff(numeric_cols, "risk")
rows_with_zero <- apply(usable_point_data[, numeric_cols_no_risk, drop = FALSE], 1, function(row) any(row == 0, na.rm = TRUE))
usable_point_data <- usable_point_data[!rows_with_zero, ]

cat("Remaining rows after removing rows with zeros (excluding 'risk'):", nrow(usable_point_data), "\n")
```

```{r}
cat_cols <- c("status", "flowline_action", "location_type", "fluid", "material")

none_counts <- sapply(usable_point_data[, cat_cols], function(col) {
  sum(as.character(col) == "None", na.rm = TRUE)
})

cat("Number of 'None' entries in each categorical column:\n")
print(none_counts)
```

```{r} 
usable_point_data <- usable_point_data %>%
  filter(across(all_of(cat_cols), ~ as.character(.) != "None"))

cat("Remaining rows after removing 'None':", nrow(usable_point_data), "\n")
```

```{r} 
usable_point_data <- usable_point_data %>%
  filter(across(all_of(cat_cols), ~ as.character(.) != "None")) %>%
  filter(location_type != "Gathering Line")

cat("Remaining rows after removing 'None' and 'Gathering Line':", nrow(usable_point_data), "\n")
```

```{r}
usable_point_data <- usable_point_data %>%
  mutate(across(
    c(status, flowline_action, location_type, fluid, material),
    ~ factor(gsub(" ", "_", as.character(.x)))
  ))
```

```{r}
# Count how many of each risk level
usable_point_data %>%
  count(risk)
```


```{r}
st_write(usable_point_data, "usable_point_data.geojson", delete_dsn = TRUE)
```

