---
title: "glm_and_sp"
output: pdf_document
date: "2025-06-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
setwd("~/Desktop/MINES/COGCC-Risk-Analysis/IC_Scripts/2024-2025/sp_point_data")
```


```{r}
library(dplyr)

# Attach NE attributes to a new data frame
df_ne_full <- df[quads$NE, ]
coord_ne <- coord_mat[quads$NE, ]  # regrabbed from earlier
df_ne_full$lon <- coord_ne[, 1]
df_ne_full$lat <- coord_ne[, 2]

to.factor <- c("status","flowline_action","location_type","fluid","material")
df_ne_full <- df_ne_full %>% mutate(across(all_of(to.factor), as.factor))

# 1. Fit logistic regression using predictors
glm_ne <- glm(risk ~ status + fluid + material + location_type +
                    diameter_in + length_ft + max_operating_pressure +
                    line_age_yr + avg_population + avg_elevation,
                  data   = df_ne_full,
                  family = binomial)

# 2. Get linear predictor (logit scale)
nu_cov <- predict(glm_ne, type = "link")

# 3. Run logistic smoother using glm logit as nuOld
coords_ne <- as.matrix(df_ne_full[, c("lon", "lat")])
risk_ne2 <- df_ne_full$risk

# look_ne_cov <- logisticSmoother(coords_ne, risk_ne2, lambda = 1e-2, nuOld = nu_cov)

# 4. Combine glm and spatial predictions
spatial_resid <- predict(look_ne, x = coords_ne)
eta_final <- nu_cov + spatial_resid
p_final <- exp(eta_final) / (1 + exp(eta_final))

# 5. Store results
result_ne_cov <- data.frame(
  lon = coords_ne[,1],
  lat = coords_ne[,2],
  observed_risk = risk_ne2,
  predicted_prob = p_final
)
```

```{r}
ggplot(result_ne_cov, aes(x = lon, y = lat)) +
  geom_point(aes(color = predicted_prob), size = 2) +
  scale_color_viridis_c(option = "D", name = "Predicted Risk") +
  coord_fixed() +
  theme_minimal() +
  labs(title = "Predicted Risk (GLM + Spatial Smoother) - NE Quadrant")
```

```{r}
library(leaflet)
library(sf)
library(dplyr)

# 1. Convert your result_ne_cov into an sf object
result_ne_sf <- st_as_sf(result_ne_cov, coords = c("lon", "lat"), crs = 4326)

# 2. Create a color palette (Viridis-like)
pal <- colorNumeric(
  palette = "viridis",
  domain = result_ne_sf$predicted_prob
)

# 3. Plot using leaflet
leaflet(result_ne_sf) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    radius      = 4,
    stroke      = FALSE,
    fillOpacity = 0.8,
    color       = ~pal(predicted_prob),
    label       = ~paste0("Predicted Risk: ", round(predicted_prob, 3))
  ) %>%
  addLegend(
    "bottomright",
    pal    = pal,
    values = ~predicted_prob,
    title  = "Predicted Risk",
    labFormat = labelFormat(digits = 2)
  )

```